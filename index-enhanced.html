<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jail Visit Logger - Enhanced Security</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #e4e4e4;
            --text-secondary: #a0a0a0;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --border-color: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Security Warning Banner */
        .security-warning {
            background: var(--accent-success);
            color: #000;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        /* Login Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-form {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
            color: var(--text-primary);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .auth-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .auth-button:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .secondary-button:hover {
            background: var(--border-color);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .info-message {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .auth-link {
            display: block;
            text-align: center;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .pin-input {
            text-align: center;
            font-size: 24px;
            letter-spacing: 8px;
            font-weight: 600;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: var(--text-secondary);
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            background: var(--bg-secondary);
            padding: 0 15px;
        }

        /* Main App (same as before) */
        .app-container {
            display: none;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .app-header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .logout-button, .clear-data-button {
            padding: 10px 20px;
            background: var(--accent-danger);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .clear-data-button {
            background: var(--accent-warning);
        }

        .logout-button:hover {
            background: #dc2626;
        }

        .clear-data-button:hover {
            background: #d97706;
        }

        /* Settings, stats, buttons, etc. - same as before */
        .settings-section {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .action-button {
            padding: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .record-button {
            border-color: var(--accent-danger);
        }

        .record-button.recording {
            background: var(--accent-danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .manual-button {
            border-color: var(--accent-primary);
        }

        .pdf-button {
            border-color: var(--accent-success);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Modal, visits, etc. - copy from original */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-secondary);
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            position: relative;
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .close-button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .save-button {
            margin-top: 20px;
            padding: 14px 28px;
            background: var(--accent-success);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-button:hover {
            background: #059669;
        }

        .delete-button {
            margin-top: 20px;
            margin-left: 10px;
            padding: 14px 28px;
            background: var(--accent-danger);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delete-button:hover {
            background: #dc2626;
        }

        .visits-section {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .visits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .visit-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .visit-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--accent-primary);
        }

        .visit-date {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .client-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .visit-location {
            font-size: 14px;
            color: var(--accent-primary);
        }

        .transcription-box {
            display: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
        }

        .transcription-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .transcription-text {
            font-size: 16px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .visits-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Security Warning -->
    <div class="security-warning" id="securityWarning">
        ðŸ”’ Enhanced Security: Multi-user authentication with SMS/Email verification enabled
    </div>

    <!-- Authentication Screen -->
    <div class="auth-container" id="authScreen">
        <div class="auth-form">
            <h1 class="auth-title">Jail Visit Logger</h1>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showLoginTab()">Login</button>
                <button class="auth-tab" onclick="showRegisterTab()">Register</button>
                <button class="auth-tab" onclick="showPinTab()">Quick PIN</button>
            </div>

            <div id="messages"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required>
                    </div>
                    
                    <button type="submit" class="auth-button">Login</button>
                </form>

                <div class="divider"><span>or</span></div>
                
                <button class="auth-button secondary-button" onclick="showQuickPin()">
                    ðŸ“± Quick PIN Login
                </button>

                <a class="auth-link" onclick="showForgotPassword()">Forgot your password?</a>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label" for="regUsername">Username</label>
                        <input type="text" id="regUsername" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regPassword">Password</label>
                        <input type="password" id="regPassword" class="form-input" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="regEmail">Email Address</label>
                        <input type="email" id="regEmail" class="form-input" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="regPhone">Phone Number</label>
                        <input type="tel" id="regPhone" class="form-input" placeholder="Optional (for SMS)">
                    </div>

                    <div class="info-message">
                        Provide either email or phone number for account verification and password recovery.
                    </div>
                    
                    <button type="submit" class="auth-button">Create Account</button>
                </form>
            </div>

            <!-- PIN Login Form -->
            <div id="pinForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="pinUsername">Username</label>
                    <input type="text" id="pinUsername" class="form-input" required>
                </div>
                
                <button type="button" class="auth-button" onclick="requestPIN()">
                    ðŸ“± Send PIN to My Device
                </button>

                <div id="pinInputSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="pinCode">Enter 6-Digit PIN</label>
                        <input type="text" id="pinCode" class="form-input pin-input" maxlength="6" pattern="[0-9]{6}">
                    </div>
                    
                    <button type="button" class="auth-button" onclick="verifyPIN()">
                        Verify PIN
                    </button>
                </div>
            </div>

            <!-- Verification Form -->
            <div id="verificationForm" style="display: none;">
                <div class="info-message">
                    A verification code has been sent to your device. Please enter it below.
                </div>

                <div class="form-group">
                    <label class="form-label" for="verificationCode">6-Digit Verification Code</label>
                    <input type="text" id="verificationCode" class="form-input pin-input" maxlength="6" pattern="[0-9]{6}" required>
                </div>
                
                <button type="button" class="auth-button" onclick="verifyRegistration()">
                    Verify Account
                </button>

                <a class="auth-link" onclick="backToRegister()">Back to Registration</a>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" style="display: none;">
                <div class="info-message">
                    Enter your username to receive a password reset code.
                </div>

                <div class="form-group">
                    <label class="form-label" for="resetUsername">Username</label>
                    <input type="text" id="resetUsername" class="form-input" required>
                </div>
                
                <button type="button" class="auth-button" onclick="requestPasswordReset()">
                    Send Reset Code
                </button>

                <div id="resetCodeSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="resetCode">6-Digit Reset Code</label>
                        <input type="text" id="resetCode" class="form-input pin-input" maxlength="6" pattern="[0-9]{6}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password</label>
                        <input type="password" id="newPassword" class="form-input" required minlength="6">
                    </div>
                    
                    <button type="button" class="auth-button" onclick="confirmPasswordReset()">
                        Reset Password
                    </button>
                </div>

                <a class="auth-link" onclick="backToLogin()">Back to Login</a>
            </div>
        </div>
    </div>

    <!-- Main App (same structure as before) -->
    <div class="app-container" id="mainApp">
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">Jail Visit Logger</h1>
                <div class="header-buttons">
                    <button class="clear-data-button" onclick="confirmClearData()">Clear All Data</button>
                    <button class="logout-button" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <div class="settings-section">
            <div class="settings-grid">
                <div class="form-group">
                    <label class="form-label" for="attorneyName">Attorney Name</label>
                    <input type="text" id="attorneyName" class="form-input" placeholder="Enter attorney name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="courtDivision">Court Division</label>
                    <input type="text" id="courtDivision" class="form-input" placeholder="Enter court division">
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="monthVisits">0</div>
                <div class="stat-label">This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVisits">0</div>
                <div class="stat-label">Total Visits</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniqueClients">0</div>
                <div class="stat-label">Unique Clients</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-button record-button" id="recordButton" onclick="toggleRecording()">
                <span>ðŸŽ¤</span> Tap to Record Visit
            </button>
            <button class="action-button manual-button" onclick="showManualEntry()">
                <span>âž•</span> Manual Entry
            </button>
            <button class="action-button pdf-button" onclick="generatePDF()">
                <span>ðŸ“„</span> Generate Monthly PDF
            </button>
        </div>

        <div class="transcription-box" id="transcriptionBox">
            <div class="transcription-label">Transcription:</div>
            <div class="transcription-text" id="transcriptionText"></div>
        </div>

        <div class="visits-section">
            <h2 class="section-title">Recent Visits</h2>
            <div class="visits-grid" id="visitsList"></div>
        </div>
    </div>

    <!-- Manual Entry Modal (same as before) -->
    <div class="modal" id="manualEntryModal">
        <div class="modal-content">
            <button class="close-button" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle">Add Visit</h2>
            
            <form onsubmit="saveVisit(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="dateInput">Date</label>
                        <input type="date" id="dateInput" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="timeInput">Time</label>
                        <input type="time" id="timeInput" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="clientName">Client Name</label>
                        <input type="text" id="clientName" class="form-input" placeholder="Enter client name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="location">Location (Pod)</label>
                        <input type="text" id="location" class="form-input" placeholder="e.g., A-32-B" pattern="[A-Z]-\d+-[A-Z]" title="Format: A-32-B" required>
                    </div>
                </div>
                
                <div class="form-row" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label class="form-label" for="notes">Notes</label>
                        <textarea id="notes" class="form-input" rows="4" placeholder="Enter any additional notes"></textarea>
                    </div>
                </div>
                
                <button type="submit" class="save-button">Save Visit</button>
                <button type="button" class="delete-button" id="deleteButton" onclick="deleteVisit()" style="display: none;">Delete Visit</button>
            </form>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://jail-visit-api-enhanced.dlkarpay.workers.dev'; // Update this
        let authToken = null;
        let currentUserId = null;
        let pendingUsername = null; // For verification flow

        // UI State
        let currentAuthTab = 'login';
        let visits = [];
        let isRecording = false;
        let recognition = null;
        let editingVisitId = null;
        let isAuthenticated = false;

        // API Module
        const API = {
            async request(endpoint, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (authToken && !endpoint.includes('/login') && !endpoint.includes('/register') && !endpoint.includes('/verify') && !endpoint.includes('/reset') && !endpoint.includes('/request-pin')) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }
                
                return data;
            },

            async register(username, password, email, phone) {
                return await this.request('/api/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, password, email, phone })
                });
            },

            async verifyRegistration(username, code) {
                return await this.request('/api/verify-registration', {
                    method: 'POST',
                    body: JSON.stringify({ username, code })
                });
            },

            async login(username, password) {
                const result = await this.request('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                authToken = result.token;
                currentUserId = result.userId;
                sessionStorage.setItem('authToken', authToken);
                sessionStorage.setItem('userId', currentUserId);
                
                return result;
            },

            async requestPIN(username) {
                return await this.request('/api/request-pin', {
                    method: 'POST',
                    body: JSON.stringify({ username })
                });
            },

            async verifyPIN(username, pin) {
                const result = await this.request('/api/verify-pin', {
                    method: 'POST',
                    body: JSON.stringify({ username, pin })
                });
                
                authToken = result.token;
                currentUserId = result.userId;
                sessionStorage.setItem('authToken', authToken);
                sessionStorage.setItem('userId', currentUserId);
                
                return result;
            },

            async requestPasswordReset(username) {
                return await this.request('/api/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({ username })
                });
            },

            async confirmPasswordReset(username, code, newPassword) {
                return await this.request('/api/confirm-reset', {
                    method: 'POST',
                    body: JSON.stringify({ username, code, newPassword })
                });
            },

            async getVisits() {
                return await this.request('/api/visits');
            },

            async saveVisit(visit) {
                return await this.request('/api/visits', {
                    method: 'POST',
                    body: JSON.stringify(visit)
                });
            },

            async updateVisit(id, visit) {
                return await this.request(`/api/visits/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(visit)
                });
            },

            async deleteVisit(id) {
                return await this.request(`/api/visits/${id}`, {
                    method: 'DELETE'
                });
            },

            async getSettings() {
                return await this.request('/api/settings');
            },

            async saveSettings(settings) {
                return await this.request('/api/settings', {
                    method: 'PUT',
                    body: JSON.stringify(settings)
                });
            }
        };

        // UI Helper Functions
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function hideAllAuthForms() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('pinForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        function updateAuthTabs(activeTab) {
            currentAuthTab = activeTab;
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            if (activeTab === 'login') document.querySelectorAll('.auth-tab')[0].classList.add('active');
            if (activeTab === 'register') document.querySelectorAll('.auth-tab')[1].classList.add('active');
            if (activeTab === 'pin') document.querySelectorAll('.auth-tab')[2].classList.add('active');
        }

        // Auth Tab Functions
        function showLoginTab() {
            clearMessages();
            hideAllAuthForms();
            updateAuthTabs('login');
            document.getElementById('loginForm').style.display = 'block';
        }

        function showRegisterTab() {
            clearMessages();
            hideAllAuthForms();
            updateAuthTabs('register');
            document.getElementById('registerForm').style.display = 'block';
        }

        function showPinTab() {
            clearMessages();
            hideAllAuthForms();
            updateAuthTabs('pin');
            document.getElementById('pinForm').style.display = 'block';
        }

        function showVerificationForm() {
            clearMessages();
            hideAllAuthForms();
            updateAuthTabs('');
            document.getElementById('verificationForm').style.display = 'block';
        }

        function showForgotPassword() {
            clearMessages();
            hideAllAuthForms();
            updateAuthTabs('');
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        function showQuickPin() {
            showPinTab();
            // Auto-fill username if available
            const lastUsername = sessionStorage.getItem('lastUsername');
            if (lastUsername) {
                document.getElementById('pinUsername').value = lastUsername;
            }
        }

        function backToLogin() {
            showLoginTab();
        }

        function backToRegister() {
            showRegisterTab();
        }

        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await API.login(username, password);
                sessionStorage.setItem('lastUsername', username);
                showMainApp();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            
            if (!email && !phone) {
                showMessage('Please provide either an email address or phone number for verification.', 'error');
                return;
            }
            
            try {
                const result = await API.register(username, password, email || null, phone || null);
                pendingUsername = username;
                showMessage(result.message, 'success');
                showVerificationForm();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function verifyRegistration() {
            const code = document.getElementById('verificationCode').value;
            
            if (!code || code.length !== 6) {
                showMessage('Please enter a valid 6-digit code.', 'error');
                return;
            }
            
            try {
                await API.verifyRegistration(pendingUsername, code);
                showMessage('Account verified successfully! You are now logged in.', 'success');
                showMainApp();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function requestPIN() {
            const username = document.getElementById('pinUsername').value;
            
            if (!username) {
                showMessage('Please enter your username.', 'error');
                return;
            }
            
            try {
                const result = await API.requestPIN(username);
                showMessage(result.message, 'success');
                document.getElementById('pinInputSection').style.display = 'block';
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function verifyPIN() {
            const username = document.getElementById('pinUsername').value;
            const pin = document.getElementById('pinCode').value;
            
            if (!pin || pin.length !== 6) {
                showMessage('Please enter a valid 6-digit PIN.', 'error');
                return;
            }
            
            try {
                await API.verifyPIN(username, pin);
                sessionStorage.setItem('lastUsername', username);
                showMessage('PIN verified! You are now logged in.', 'success');
                showMainApp();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function requestPasswordReset() {
            const username = document.getElementById('resetUsername').value;
            
            if (!username) {
                showMessage('Please enter your username.', 'error');
                return;
            }
            
            try {
                const result = await API.requestPasswordReset(username);
                showMessage(result.message, 'info');
                document.getElementById('resetCodeSection').style.display = 'block';
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        async function confirmPasswordReset() {
            const username = document.getElementById('resetUsername').value;
            const code = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            
            if (!code || code.length !== 6) {
                showMessage('Please enter a valid 6-digit reset code.', 'error');
                return;
            }
            
            if (!newPassword || newPassword.length < 6) {
                showMessage('Password must be at least 6 characters.', 'error');
                return;
            }
            
            try {
                const result = await API.confirmPasswordReset(username, code, newPassword);
                showMessage(result.message, 'success');
                setTimeout(() => {
                    showLoginTab();
                }, 2000);
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Main App Functions (same as before)
        async function showMainApp() {
            isAuthenticated = true;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            await loadData();
            initializeSpeechRecognition();
            updateStats();
            
            document.getElementById('attorneyName').addEventListener('change', saveSettings);
            document.getElementById('courtDivision').addEventListener('change', saveSettings);
        }

        function logout() {
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('userId');
            authToken = null;
            currentUserId = null;
            location.reload();
        }

        async function loadData() {
            try {
                visits = await API.getVisits();
                const settings = await API.getSettings();
                document.getElementById('attorneyName').value = settings.attorneyName || '';
                document.getElementById('courtDivision').value = settings.courtDivision || '';
                renderVisits();
            } catch (e) {
                console.error('Failed to load data:', e);
                visits = [];
            }
        }

        async function saveSettings() {
            try {
                await API.saveSettings({
                    attorneyName: document.getElementById('attorneyName').value,
                    courtDivision: document.getElementById('courtDivision').value
                });
            } catch (e) {
                console.error('Failed to save settings:', e);
            }
        }

        function updateStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthVisits = visits.filter(visit => {
                const visitDate = new Date(visit.date);
                return visitDate.getMonth() === currentMonth && visitDate.getFullYear() === currentYear;
            });

            const uniqueClients = [...new Set(visits.map(v => v.clientName))].length;

            document.getElementById('monthVisits').textContent = monthVisits.length;
            document.getElementById('totalVisits').textContent = visits.length;
            document.getElementById('uniqueClients').textContent = uniqueClients;
        }

        function renderVisits() {
            const visitsList = document.getElementById('visitsList');
            visitsList.innerHTML = '';
            
            const recentVisits = visits.slice(0, 12);
            
            recentVisits.forEach(visit => {
                const visitCard = document.createElement('div');
                visitCard.className = 'visit-card';
                visitCard.onclick = () => showManualEntry(visit.id);
                
                const visitDate = new Date(visit.date);
                const dateStr = visitDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                visitCard.innerHTML = `
                    <div class="visit-date">${dateStr}</div>
                    <div class="client-name">${visit.clientName}</div>
                    <div class="visit-location">${visit.location}</div>
                `;
                
                visitsList.appendChild(visitCard);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            authToken = sessionStorage.getItem('authToken');
            currentUserId = sessionStorage.getItem('userId');
            
            if (authToken && currentUserId) {
                try {
                    await API.getVisits();
                    showMainApp();
                } catch (e) {
                    sessionStorage.removeItem('authToken');
                    sessionStorage.removeItem('userId');
                    authToken = null;
                    currentUserId = null;
                }
            }

            document.getElementById('dateInput').valueAsDate = new Date();
        });

        // Speech recognition and other functions would be the same as before
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('transcriptionText').textContent = transcript;
                    document.getElementById('transcriptionBox').style.display = 'block';
                    parseTranscription(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    stopRecording();
                };
                
                recognition.onend = function() {
                    stopRecording();
                };
            } else {
                document.getElementById('recordButton').innerHTML = '<span>ðŸŽ¤</span> Voice not supported';
                document.getElementById('recordButton').disabled = true;
            }
        }

        function toggleRecording() {
            if (!recognition) return;
            
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
                startRecording();
            }
        }

        function startRecording() {
            isRecording = true;
            const button = document.getElementById('recordButton');
            button.innerHTML = '<span>ðŸ”´</span> Recording...';
            button.classList.add('recording');
        }

        function stopRecording() {
            isRecording = false;
            const button = document.getElementById('recordButton');
            button.innerHTML = '<span>ðŸŽ¤</span> Tap to Record Visit';
            button.classList.remove('recording');
        }

        async function parseTranscription(text) {
            const patterns = [
                /visited\s+(.+?)\s+(?:in|at)\s+([A-Z]-\d+-[A-Z])/i,
                /saw\s+(.+?)\s+(?:in|at)\s+([A-Z]-\d+-[A-Z])/i,
                /met\s+(?:with\s+)?(.+?)\s+(?:in|at)\s+([A-Z]-\d+-[A-Z])/i,
                /(.+?)\s+(?:in|at|pod)\s+([A-Z]-\d+-[A-Z])/i
            ];

            let clientName = '';
            let location = '';

            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    clientName = match[1].trim();
                    location = match[2].toUpperCase();
                    break;
                }
            }

            if (clientName && location) {
                const visitData = {
                    date: new Date().toISOString(),
                    clientName: clientName,
                    location: location,
                    notes: `Recorded via voice: "${text}"`
                };

                try {
                    const newVisit = await API.saveVisit(visitData);
                    visits.unshift(newVisit);
                    updateStats();
                    renderVisits();
                    
                    setTimeout(() => {
                        document.getElementById('transcriptionBox').style.display = 'none';
                    }, 3000);
                } catch (e) {
                    console.error('Failed to save voice visit:', e);
                    showManualEntry();
                    document.getElementById('clientName').value = clientName;
                    document.getElementById('location').value = location;
                    document.getElementById('notes').value = `Voice note: "${text}"`;
                }
            } else {
                showManualEntry();
                if (clientName) document.getElementById('clientName').value = clientName;
                if (location) document.getElementById('location').value = location;
                document.getElementById('notes').value = `Voice note: "${text}"`;
            }
        }

        // Manual entry and other functions remain the same
        function showManualEntry(visitId = null) {
            editingVisitId = visitId;
            const modal = document.getElementById('manualEntryModal');
            const form = modal.querySelector('form');
            
            if (visitId) {
                const visit = visits.find(v => v.id === visitId);
                if (visit) {
                    document.getElementById('modalTitle').textContent = 'Edit Visit';
                    document.getElementById('dateInput').value = visit.date.split('T')[0];
                    document.getElementById('timeInput').value = visit.date.split('T')[1].substring(0, 5);
                    document.getElementById('clientName').value = visit.clientName;
                    document.getElementById('location').value = visit.location;
                    document.getElementById('notes').value = visit.notes || '';
                    document.getElementById('deleteButton').style.display = 'inline-block';
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Add Visit';
                form.reset();
                document.getElementById('dateInput').valueAsDate = new Date();
                document.getElementById('timeInput').value = new Date().toTimeString().substring(0, 5);
                document.getElementById('deleteButton').style.display = 'none';
            }
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('manualEntryModal').style.display = 'none';
            editingVisitId = null;
        }

        async function saveVisit(event) {
            event.preventDefault();
            
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const visitData = {
                date: new Date(`${date}T${time}`).toISOString(),
                clientName: document.getElementById('clientName').value.trim(),
                location: document.getElementById('location').value.toUpperCase(),
                notes: document.getElementById('notes').value.trim()
            };

            try {
                if (editingVisitId) {
                    const updatedVisit = await API.updateVisit(editingVisitId, visitData);
                    const index = visits.findIndex(v => v.id === editingVisitId);
                    if (index !== -1) {
                        visits[index] = updatedVisit;
                    }
                } else {
                    const newVisit = await API.saveVisit(visitData);
                    visits.unshift(newVisit);
                }

                updateStats();
                renderVisits();
                closeModal();
            } catch (e) {
                console.error('Failed to save visit:', e);
                alert('Failed to save visit. Please try again.');
            }
        }

        async function deleteVisit() {
            if (!editingVisitId) return;
            
            if (confirm('Are you sure you want to delete this visit?')) {
                try {
                    await API.deleteVisit(editingVisitId);
                    visits = visits.filter(v => v.id !== editingVisitId);
                    updateStats();
                    renderVisits();
                    closeModal();
                } catch (e) {
                    console.error('Failed to delete visit:', e);
                    alert('Failed to delete visit. Please try again.');
                }
            }
        }

        async function confirmClearData() {
            if (confirm('âš ï¸ WARNING: This will permanently delete ALL visit data and settings. This cannot be undone. Are you sure?')) {
                if (confirm('This is your last chance. Do you really want to delete everything?')) {
                    try {
                        for (const visit of visits) {
                            await API.deleteVisit(visit.id);
                        }
                        
                        await API.saveSettings({ attorneyName: '', courtDivision: '' });
                        
                        visits = [];
                        renderVisits();
                        updateStats();
                        document.getElementById('attorneyName').value = '';
                        document.getElementById('courtDivision').value = '';
                        
                        alert('All data has been cleared successfully.');
                    } catch (e) {
                        console.error('Failed to clear data:', e);
                        alert('Failed to clear all data. Please try again.');
                    }
                }
            }
        }

        function generatePDF() {
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", 
                               "July", "August", "September", "October", "November", "December"];
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthVisits = visits.filter(visit => {
                const visitDate = new Date(visit.date);
                return visitDate.getMonth() === currentMonth && visitDate.getFullYear() === currentYear;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const attorneyName = document.getElementById('attorneyName').value || '_________________';
            const courtDivision = document.getElementById('courtDivision').value || '_________________';

            let tableRows = monthVisits.map(visit => {
                const date = new Date(visit.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${visit.clientName}</td>
                        <td>${visit.location}</td>
                    </tr>
                `;
            }).join('');

            for (let i = monthVisits.length; i < 20; i++) {
                tableRows += `
                    <tr>
                        <td>____/____</td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
            }

            const printContent = `
                <style>
                    @media print {
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0;
                            padding: 40px;
                            background: white;
                            color: black;
                        }
                        h1 { 
                            text-align: center; 
                            text-decoration: underline;
                            color: black;
                            margin-bottom: 30px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px; 
                        }
                        th, td { 
                            border: 1px solid black; 
                            padding: 8px; 
                            text-align: left;
                            color: black;
                        }
                        th { 
                            font-weight: bold;
                            background: #f0f0f0;
                        }
                        .header-info { 
                            margin-bottom: 20px;
                            color: black;
                        }
                        .signature-line {
                            margin-top: 40px;
                            border-bottom: 1px solid black;
                            width: 300px;
                        }
                    }
                </style>
                <h1>Jail Visit Log - ${monthNames[currentMonth]} ${currentYear}</h1>
                <div class="header-info">
                    <p><strong>Attorney:</strong> ${attorneyName}</p>
                    <p><strong>Court Division:</strong> ${courtDivision}</p>
                    <p><strong>Total Visits This Month:</strong> ${monthVisits.length}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Client Name</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
                <div class="signature-line"></div>
                <p style="margin-top: 10px;">Signature</p>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Jail Visit Log - ${monthNames[currentMonth]} ${currentYear}</title>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        window.onclick = function(event) {
            const modal = document.getElementById('manualEntryModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>